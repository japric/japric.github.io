---
title: linuxptp源码分析
date: 2025-05-13 17:20:00 +0800
categories: [PTP]
tags: [cpp,linux,system,time]
mermaid: true
---

## 1 前言

linuxptp 是linux平台上根据IEEE standard 1588的一个Precision Time Protocol (PTP)协议实现.
更多的特性介绍可以参考页面
[linuxptp feature](https://github.com/richardcochran/linuxptp?tab=readme-ov-file#features)
这里我们尝试从功能和源码的角度进行分析

## 2 源码分析

https://github.com/richardcochran/linuxptp


### 2.1 从phc_ctl看ptp时间查询

```
phc_ctl.c
phc.c
sk.c
utils.c
```

```mermaid
sequenceDiagram  

    participant User as user  
    box phc_ctrl
    participant Main as phc_ctl.c<br>main
    participant RunCmds as phc_ctl.c<br>run_cmds
    participant GetCmd as phc_ctl.c<br>get_command_function  
    participant DoGet as phc_ctl.c<br>do_get
    participant PosixOpen as utils.c<br>posix_clock_open

    participant PhcOpen as phc.c<br>phc_open
    participant SK as sk.c
    end
    participant Kernel as Linux kernel  
    participant PHC as PTP hardware clock

  

    User->>Main: run commands phc_ctl /dev/ptp0 get  

    Main->>PosixOpen: posix_clock_open("/dev/ptp0", &junk)  
      

    alt device is PHC device path 

        PosixOpen->>PhcOpen: phc_open(device)  
        PhcOpen->>Kernel: open device file  
        Kernel-->>PhcOpen: return clockid_t  
    else device is net interface
 
        PosixOpen->>SK: sk_get_ts_info(device, &ts_info)
        SK->>Kernel: ioctl
        Kernel-->>PosixOpen: return ethtool_ts_info(X:phc_index)

        PosixOpen->>PhcOpen: phc_open("/dev/ptpX")  
        PhcOpen->>Kernel: open device file  
        Kernel-->>PhcOpen: return  clockid_t  
    end  
      

    PosixOpen-->>Main: return clockid_t  
      

    Main->>RunCmds: run_cmds(clkid, cmdc, cmdv)  
 
    RunCmds->>GetCmd: get_command_function("get")  
    GetCmd-->>RunCmds: return do_get func ptr  
      

    RunCmds->>DoGet: do_get(clkid, cmdc-i, &cmdv[i])  

    DoGet->>Kernel: clock_gettime(clkid, &ts)  

    Kernel->>PHC: read hardware time
    PHC-->>Kernel: return time
    Kernel-->>DoGet: return time struct
      

    DoGet->>DoGet: serialize time information
    DoGet-->>RunCmds: return 0
    RunCmds-->>Main: return result
    Main-->>User: show time information
```

关键步骤为
`phc_open`打开ptp设备, 拿到clkid, `clock_gettime`获取时间


### 2.2 E2E mode

```mermaid
sequenceDiagram  
    participant Master as server(Master)  
    participant Slave as client(Slave)  
      
    Master->>Slave: SYNC  
    Note over Master,Slave: t1: send timestamps  
    Note over Master,Slave: t2: receive timestamps  
      
    alt 2 step clock  
        Master->>Slave: FOLLOW_UP (include t1)  
    end  
      
    Slave->>Master: DELAY_REQ  
    Note over Master,Slave: t3: send timestamps  
    Note over Master,Slave: t4: receive timestamps  
      
    Master->>Slave: DELAY_RESP (include t4)  
      
    Note over Slave: Calculate path delays and clock offsets
```



详细的序列图
```mermaid
sequenceDiagram  
    participant Master as 主时钟(Master)  
    participant MPort as 主时钟端口  
    participant SPort as 从时钟端口  
    participant Slave as 从时钟(Slave)

    %% rect rgb(0xE6, 0xE6, 0xE6)
    note right of Master: SYNC 消息流程  
    Master->>MPort: port_tx_sync()  
    activate MPort  
    MPort->>MPort: msg_allocate()  
    MPort->>MPort: 设置 SYNC 消息头  
    MPort->>SPort: port_prepare_and_send(TRANS_EVENT)  
    MPort-->>Master: 返回  
    deactivate MPort  
      
    %% SYNC 消息处理  
    SPort->>SPort: bc_event() 检测消息  
    activate SPort  
    SPort->>SPort: msg_type(msg) == SYNC  
    SPort->>SPort: process_sync(p, msg)  
    SPort->>Slave: clock_synchronize()  
    SPort-->>SPort: 返回  
    deactivate SPort  
    %% end

    note right of Master: FOLLOW_UP 消息流程  
    %% FOLLOW_UP 消息流程（2 step clock）  
    Master->>MPort: port_tx_sync() 继续执行  
    activate MPort  
    MPort->>MPort: msg_allocate() 创建 FOLLOW_UP  
    MPort->>MPort: 设置 FOLLOW_UP 消息头  
    MPort->>MPort: fup->follow_up.preciseOriginTimestamp = tmv_to_Timestamp(msg->hwts.ts)  
    MPort->>SPort: port_prepare_and_send(TRANS_GENERAL)  
    MPort-->>Master: 返回  
    deactivate MPort  
      
    %% FOLLOW_UP 消息处理  
    SPort->>SPort: bc_event() 检测消息  
    activate SPort  
    SPort->>SPort: msg_type(msg) == FOLLOW_UP  
    SPort->>SPort: process_follow_up(p, msg)  
    SPort-->>SPort: 返回  
    deactivate SPort  

    note left of Slave: DELAY_REQUEST 消息流程  
    %% DELAY_REQUEST 消息流程  
    Slave->>SPort: port_delay_request()  
    activate SPort  
    SPort->>SPort: msg_allocate()  
    SPort->>SPort: 设置 DELAY_REQ 消息头  
    SPort->>MPort: port_prepare_and_send(TRANS_EVENT)  
    SPort->>SPort: TAILQ_INSERT_HEAD(&p->delay_req, msg, list)  
    SPort-->>Slave: 返回  
    deactivate SPort  
      
    %% DELAY_REQUEST 消息处理  
    MPort->>MPort: bc_event() 检测消息  
    activate MPort  
    MPort->>MPort: msg_type(msg) == DELAY_REQ  
    MPort->>MPort: process_delay_req(p, msg)  
    note right of Master: DELAY_RESPONSE 消息流程  
    MPort->>MPort: msg_allocate() 创建响应  
    MPort->>MPort: 设置 DELAY_RESP 消息头  
    MPort->>MPort: msg->delay_resp.receiveTimestamp = tmv_to_Timestamp(m->hwts.ts)  
    MPort->>SPort: port_prepare_and_send(TRANS_GENERAL)  
    MPort-->>MPort: 返回  
    deactivate MPort  

    %% DELAY_RESPONSE 消息处理  
    SPort->>SPort: bc_event() 检测消息  
    activate SPort  
    SPort->>SPort: msg_type(msg) == DELAY_RESP  
    SPort->>SPort: process_delay_resp(p, msg)  
    SPort->>SPort: 在 p->delay_req 中查找匹配请求  
    SPort->>SPort: 提取时间戳 (t3, t4)  
    SPort->>Slave: clock_path_delay(p->clock, t3, t4c)  
    SPort->>SPort: TAILQ_REMOVE(&p->delay_req, req, list)  
    SPort->>SPort: msg_put(req)  
    SPort-->>SPort: 返回  
    deactivate SPort
```


